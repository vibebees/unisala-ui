---
export const prerender = false;

import MainLayout from '@/layouts/main-layout.astro';
import ThreadSkeleton from '@/components/layout/skeleton/thread.astro';
// import { USER_SERVICE_GQL } from '@/datasource/servers/types';
import SingleThread from '@/components/packages/thread/singleThread/index';
const { slug } = Astro.params;
console.log("Fetching data for slug:", slug);

let post = null;
let error = null;

const query = `
query getPostById($id: String!, $user: String) {
      getPostById(id: $id, user: $user) {
        status {
          success
          message
        }
        post {
          _id
          postText
          postCommentsCount
          admissionAndApplicationRating
          financialAidAndScholarshipRating
          academicProgramsAndDepartmentRating
          studentLifeAndServiceRating
          careerAndAlumniResourceRating
          postType
          postImage
          videoURL
          date
          tags {
            _id
            name
            parentId
            image
            description
          }
          postTags{
            tagType
            tag{
              _id
              name
            }
          }
          upVoted
          images
          upVoteCount
          user {
            _id
            username
            picture
          }
          comments {
            _id
            commentText
            upVoted
            upVoteCount
           
          }
        }
      }
    }
`;

try {
  const response = await fetch('http://localhost:4444/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      query,
      variables: { id: '667adc362bf59de35465faa1', user: null }, // Add user if needed
    }),
  });

  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }

  const result = await response.json();

  if (result.errors) {
    throw new Error(result.errors[0].message);
  }

  post = result.data?.getPostById?.post;

  if (!post) {
    throw new Error('Post not found');
  }
} catch (e) {
  console.error("Error fetching post:", e);
  error = e instanceof Error ? e.message : String(e);
}

---

<MainLayout title={post ? `${post.postText.slice(0, 20)}...` : 'Thread'}>
  {error && (
    <div class="error-container">
      <h2>Error</h2>
      <p>{error}</p>
    </div>
  )}
  
  {!post && !error && <ThreadSkeleton />}
  
  {post &&  <SingleThread post = {post} />}
</MainLayout>
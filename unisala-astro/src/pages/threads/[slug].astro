---
export const prerender = false;

import MainLayout from '@/layouts/main-layout.astro';
import ThreadSkeleton from '@/components/layout/skeleton/thread.astro';
import SingleThread from '@/components/packages/thread/singleThread/index';
import Comments from '@/components/thread/comments/index.tsx';
import ThreadHeader from '@/components/layout/thread-header.astro';
import ThreadAction from '@/components/thread/thread.action.astro';
import { Badge } from '@/components/ui/badge';
import linkifyHtml from 'linkify-html';
import { Toaster, toast } from "react-hot-toast";
import ThreadActionTsx from '@/components/thread/actions/upvote';
import { fetchApi } from '@/utils/api.utility';
import { USER_SERVICE_GQL } from '@/datasource/servers/types';
const { slug ="" } = Astro.params;
const loadingToastId = toast.loading('Loading...');
import {userServiceGql} from '@/datasource/servers/index';
import {Toast} from '@/components/ui/toast';
import { FourOhFour } from '@/components/ui/404';
import ThreadSuggestions from '@/components/thread/organisms/thread.suggestion.astro'
import SameWriterSuggestions from '@/components/thread/organisms/same.writer.suggestion.astro'

import { ThreadAuthor } from '@/components/thread/organisms/thread.author';

let post = null;
let error: string = '';
// Remove the assignment to prerender
const query = `
  query getPostById($id: String!, $user: String) {
    getPostById(id: $id, user: $user) {
      status {
        success
        message
      }
      post {
        _id
        postText
        title
        postCommentsCount
        admissionAndApplicationRating
        financialAidAndScholarshipRating
        academicProgramsAndDepartmentRating
        studentLifeAndServiceRating
        careerAndAlumniResourceRating
        postType
        postImage
        videoURL
        date
        tags {
          _id
          name
          parentId
          image
          description
        }
        postTags {
          tagType
          tag {
            _id
            name
          }
        }
        upVoted
        images
        upVoteCount
        user {
          _id
          username
          firstName
          lastName
          picture
        }
        comments {
          _id
          commentText
          upVoted
          upVoteCount
          user {
            _id
            firstName
            lastName
            picture
            username
          }
        }
      }
    }
  }
`;
console.log({userServiceGql})
try {
  const result = await fetchApi(userServiceGql, {
    method: 'POST',
    body: JSON.stringify({
      query,
      variables: { id: slug, user: null },
    }),
  });

  if (result.errors) {
    throw new Error(result.errors[0].message);
  }

  post = result.data?.getPostById?.post;


} catch (e) {
  console.error("Error fetching post:", e);
  error = e instanceof Error ? e.message : String(e);
}

function extractHeading(text: string): string {
  // First, try to extract content from heading tags (h1 to h6)
  const headingMatch = text.match(/<h[1-6][^>]*>(.*?)<\/h[1-6]>/i);
  if (headingMatch) {
    // Remove any nested HTML tags from the heading content
    return headingMatch[1].replace(/<\/?[^>]+(>|$)/g, "").trim();
  }

  // If no heading tags, try to extract the first non-empty paragraph
  const paragraphMatch = text.match(/<p[^>]*>(.*?)<\/p>/i);
  if (paragraphMatch) {
    // Remove any nested HTML tags from the paragraph content
    const cleanParagraph = paragraphMatch[1].replace(/<\/?[^>]+(>|$)/g, "").trim();
    if (cleanParagraph) {
      return cleanParagraph.length > 150 ? cleanParagraph.slice(0, 147) + '...' : cleanParagraph;
    }
  }

  // If no suitable heading found, extract text from the entire content
  let cleanText = text
    .replace(/<[^>]+>/g, ' ') // Replace all HTML tags with spaces
    .replace(/&nbsp;/g, ' ')
    .replace(/&[a-z]+;/g, match => {
      const entities: { [key: string]: string } = {
        '&lt;': '<',
        '&gt;': '>',
        '&amp;': '&',
        '&quot;': '"',
        '&apos;': "'"
      };
      return entities[match] || match;
    })
    .replace(/\s+/g, ' ')
    .trim();

  // Take the first 150 characters as the heading
  return cleanText.length > 150 ? cleanText.slice(0, 147) + '...' : cleanText;
}


// heading is post.title if not empty, else extract from postText
const heading = post
                ?
                  post?.title?.length > 0 
                  ? extractHeading(post.title)
                  : extractHeading(post.postText)
                :'Loading...';

const linkifiedText = post ? linkifyHtml(post.postText, {
  defaultProtocol: 'https',
  className: 'custom-link',
  target: {
    url: '_blank'
  }
}) : '';


const handleUpvote = async (postId: string) => {
  try {
    // Call the upvote mutation or API endpoint here
    // await upvoteMutation(postId);
    alert('Upvoted');
  } catch (error) {
    // Handle the error
    console.error(error);
  }
};


---

<MainLayout
 title={post ? `${heading}` : 'Thread'}
  description={post ? linkifiedText : 'Loading...'}
  publishedTime={post?.date}
></MainLayout>
<Toast client:load />
{error && <FourOhFour message={error} />}

  {!post && !error && <ThreadSkeleton />}
  {post && (
    <section class='container max-w-screen-lg space-y-6 pt-12'>
      <ThreadHeader heading={linkifyHtml(heading)} username={post?.user?.username}  firstName={post?.user?.firstName}  lastName={post?.user?.lastName}  date={post?.date} claps={post?.upVoteCount} comments={post?.postCommentsCount} />
       <ul class='pt-6'>
        <li class='flex flex-col max-md:gap-y-4 md:flex-row w-full'>
          <div class='prose dark:prose-invert prose-img:rounded-3xl max-w-none w-full pb-24'>
            <SingleThread
            post = {post}
            />
          </div>
        </li>
        {/* <ThreadAction
          heading={heading}
          username={post?.user.username}
          date={formatDate(post.date)}
          claps={post.upVoteCount}
          comments={post.postCommentsCount}
        /> */}
        <ThreadActionTsx
          heading={heading}
          username={post?.user?.username}
          date={post?.date}
          comments={post?.postCommentsCount}
          postId={slug}
          initialClaps={post?.upVoteCount}
          client:only 'react'
          upVoted={post?.upVoted}
        />

      </ul>
    </section>
  )}

  <!-- //pass postId from slug -->

  <Comments client:only ='react'  postId = {slug}/>
  <ThreadAuthor
      author ={post?.user?.firstName + ' ' + post?.user?.lastName}
      authorDescription=''
  />

  <SameWriterSuggestions  feedId ={post?.user?._id}  />
  <hr />
  <ThreadSuggestions  feedId ={post?.postTags?.tag?._id}  />

</MainLayout>